<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Publisher/Subscriber</title>
    <!-- Include the HiveMQ MQTT library -->
    <script>
        import com.hivemq.client.mqtt.MqttClient;
        import com.hivemq.client.mqtt.datatypes.MqttQos;
        import com.hivemq.client.mqtt.mqtt5.Mqtt5BlockingClient;

        import static com.hivemq.client.mqtt.MqttGlobalPublishFilter.ALL;
        import static java.nio.charset.StandardCharsets.UTF_8;

        public class Example {


            public static void main(String[] args) {
                final String host = "95ea70d6edb34e4a956c8f346ae8fba8.s1.eu.hivemq.cloud";
                final String username = "Eidyn";
                final String password = "Mqtt1111";

                /**
                 * Building the client with ssl.
                 */
                final Mqtt5BlockingClient client = MqttClient.builder()
                        .useMqttVersion5()
                        .serverHost(host)
                        .serverPort(8884)
                        .sslWithDefaultConfig()
                        .webSocketConfig()
                            .serverPath("mqtt")
                            .applyWebSocketConfig()
                        .buildBlocking();

                /**
                 * Connect securely with username, password.
                 */
                client.connectWith()
                        .simpleAuth()
                        .username(username)
                        .password(UTF_8.encode(password))
                        .applySimpleAuth()
                        .send();

                System.out.println("Connected successfully");

                /**
                 * Subscribe to the topic "Kanyon/HV_Voltage" with qos = 2 and print the received message.
                 */
                client.subscribeWith()
                        .topicFilter("Kanyon/HV_Voltage")
                        .qos(MqttQos.EXACTLY_ONCE)
                        .send();

                /**
                 * Set a callback that is called when a message is received (using the async API style).
                 * Then disconnect the client after a message was received.
                 */
                client.toAsync().publishes(ALL, publish -> {
                    System.out.println("Received message: " + publish.getTopic() + " -> " + UTF_8.decode(publish.getPayload().get()));

                    client.disconnect();
                });

                /**
                 * Publish "1" to the topic "Kanyon/mqtt_request" with qos = 2.
                 */
                client.publishWith()
                        .topic("Kanyon/mqtt_request")
                        .payload(UTF_8.encode("1"))
                        .qos(MqttQos.EXACTLY_ONCE)
                        .send();
            }

        }
    </script>
</head>
<body>

<h1>MQTT Publisher/Subscriber</h1>

<!-- Display received values for subscribed topics -->
<div id="hvVoltage"></div>
<div id="lvVoltage"></div>
<div id="lvSoc"></div>

</body>
</html>
