<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanyon MQTT</title>
  <link rel="icon" type="image/x-icon" href="/favicon-96x96.ico">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: 'Amazon Ember', sans-serif;
      background-color: #100030;
      color: white;
    }

    .section {
      margin-bottom: 20px; /* Add margin between sections for better visibility */
    }

    .section-header {
      font-size: 1.2em;
      font-weight: bold;
      border: 2px solid #5a41fa; /* Set a solid border around the entire section header */
      padding: 8px; /* Add padding to create some space between the text and the border */
      border-radius: 8px; /* Add rounded edges to the border */
      background-color: #5a41fa; /* Set background color to match the border */
      color: #fff; /* Set text color to white for better visibility */
      margin-top: 0; /* Remove default margin on the top of section header */
    }

    .message-field {
      padding: 10px; /* Add padding for better visibility */
    }

    p {
      margin: 0; /* Remove default paragraph margin */
    }
  </style>
</head>
<body>

<!-- Login Section -->
<div id="login-section">
  <h2>Login</h2>
  <form id="login-form" onsubmit="attemptLogin(); return false;">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" required>
    <br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <br>
    <button type="submit">Login</button>
  </form>
</div>

<!-- HV Battery Section -->
<div class="section" id="hv-battery">
  <div class="section-header">HV Battery</div>
  <div class="message-field">
    <p id="hv-voltage">HV Voltage: </p>
  </div>
  <div class="message-field">
    <p id="temperature">Temperature: </p>
  </div>
</div>

<!-- LV Battery Section -->
<div class="section" id="lv-battery">
  <div class="section-header">LV Battery</div>
  <div class="message-field">
    <p id="lv-voltage">LV Voltage: </p>
  </div>
  <div class="message-field">
    <p id="lv-soc">LV SOC: </p>
  </div>
</div>

<script>

let client;

// Function to attempt login
function attemptLogin() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  // Close the existing client if it exists
  if (client) {
    client.end();
  }

  // Use the entered username and password in MQTT connection options
  const options = {
    username: username,
    password: password,
    protocol: 'wss',
    port: 8884,
    path: '/mqtt',
    clean: true,
  };

  // Create a new MQTT client
  client = mqtt.connect('tls://95ea70d6edb34e4a956c8f346ae8fba8.s1.eu.hivemq.cloud:8884', options);

  // MQTT connection callback
  client.on('connect', () => {
    console.log('Connected!');
    // Hide the login section and allow the main script to proceed
    document.getElementById('login-section').style.display = 'none';
    runMainScript();
  });

  // MQTT connection error callback
  client.on('error', (error) => {
    console.error('Connection failed:', error);
    // Display an error message or take appropriate action

    // Close the client to prevent automatic reconnection attempts
    client.end();
  });
}

// Function to run main.js after successful login
function runMainScript(username, password, client) {
  // Include main.js script dynamically
  var script = document.createElement('script');
  script.src = 'main.js';
  document.head.appendChild(script);

}

</script>

</body>
</html>
